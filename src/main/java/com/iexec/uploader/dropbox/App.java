/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package com.iexec.uploader.dropbox;

import com.iexec.uploader.dropbox.uploader.UploaderService;

import java.io.IOException;
import java.security.SignatureException;

import static com.iexec.uploader.dropbox.signer.SignerService.signEnclaveChallengeAndWriteSignature;
import static com.iexec.uploader.dropbox.utils.EnvUtils.getEnvVarOrExit;

public class App {


    public static void main(String[] args) throws IOException, SignatureException {
        System.out.println("Tee-post-compute started");
        System.out.println("(Uploader & Signer)");

        System.out.println("DEBUG - en: " + System.getenv().toString());

        System.out.println("Uploader started");
        String localFilePath = getEnvVarOrExit("LOCAL_FILE_PATH");
        String dropboxAccessToken = getEnvVarOrExit("DROPBOX_ACCESS_TOKEN");
        String remoteFilename = getEnvVarOrExit("REMOTE_FILENAME");
        boolean isUploaded = UploaderService.uploadToDropBox(localFilePath, dropboxAccessToken, remoteFilename);
        if (!isUploaded) {
            System.err.println("Uploader failed (exiting)");
            System.exit(1);
        } else {
            System.out.println("Uploaded!");
        }

        System.out.println("Signer started");
        String teeChallengePrivateKey = getEnvVarOrExit("TEE_CHALLENGE_PRIVATE_KEY");
        String taskId = getEnvVarOrExit("TASK_ID");
        String workerAddress = getEnvVarOrExit("WORKER_ADDRESS");

        boolean isSignatureFileCreated = signEnclaveChallengeAndWriteSignature(localFilePath, teeChallengePrivateKey, taskId, workerAddress);
        if (!isSignatureFileCreated) {
            System.err.println("Signer failed (exiting)");
            System.exit(1);
        } else {
            System.out.println("Signed!");
        }

        System.exit(0);
    }


}
